<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <title>Tetris</title>
        <style>
        #arena{}
        </style>
    </head>
    <body>
        <canvas id="arena">
            <script>
            var arena = document.getElementById('arena');
            arena.width = 100, arena.height = 240;
            var ctx = arena.getContext('2d');
            var last = 0;
            var blocks = [
                [[0,0],[1,0],[2,0],[3,0]],
                [[0,1],[0,0],[1,0],[2,0]],
                [[1,1],[0,0],[1,0],[2,0]],
                [[2,1],[0,0],[1,0],[2,0]],
                [[1,1],[2,1],[0,0],[1,0]],
                [[0,1],[1,1],[1,0],[2,0]],
                [[0,1],[1,1],[0,0],[1,0]],
            ];
            
            var buffer = [];
            for (var i = 0; i < 24; i++ ) {
                buffer.push((new Array(10)).fill(0))
            }
            var fall = [];
            var center = {x:4, y:2};

            function next(t) {
                var able = true;
                center.x = 4; center.y = 2;
                blocks[t].map(function(dot){
                    var x = dot[0] + center.x;
                    var y = dot[1] + center.y;
                    if (buffer[y][x] > 0) {
                        able = false;
                    }
                    buffer[y][x] += 1;
                    fall.push({x:x, y:y});
                });
                return able;
            }

            function logic(timestamp) {
                if (timestamp - last < 400) {
                    return;
                }
                last = timestamp;
                var able = fall.reduce(function(a, dot){
                    var owner = fall.reduce(function(b, odot){
                        return b || (dot.x == odot.x && dot.y+1 == odot.y);
                    }, false);
                    return a && dot.y < 23 && (buffer[dot.y + 1][dot.x] == 0 || owner)
                }, true);
                if (able) {
                    fall.map(function(dot){
                        buffer[dot.y][dot.x] -= 1;
                        dot.y += 1;
                        center.y += 1;
                        buffer[dot.y][dot.x] += 1;
                    })
                } else {
                    while (fall.length > 0) {
                        fall.pop();
                    }
                }
            }
            
            function update(timestamp) {
                ctx.fillStyle = '#ccc';
                ctx.fillRect(0, 0, arena.width, arena.height);
                logic(timestamp);
                buffer.map(function(row, y) {
                    row.map(function(t, x){
                        ctx.fillStyle = t == 0 ? '#fff' : '#000';
                        ctx.fillRect(x*10 + 0.5, y*10 + 0.5, 9, 9);
                    });
                });
                requestAnimationFrame(update);
            }

            requestAnimationFrame(update);
            </script>
        </canvas>
    </body>
</html>